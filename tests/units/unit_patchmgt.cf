
body common control

{
bundlesequence  => { "testbundle"  };

version => "1.2.3";
}

###########################################

bundle agent testbundle
{
methods:

 "any" usebundle => patch("/software/1","","server");

}

###########################################

bundle agent patch(file,md5,server)

{
vars:

  "last" string => lastnode("$(file)");

classes:

  "patch_ok" expression => hashmatch("$(file)","md5","$(md5)");

files:

 !patch_ok::

   "/tmp/$(last)"

     copy_from => rcp("/repository/$(last)","$(server)"),
       classes => define("new_patch");

 patch_ok::

   "/tmp/$(last)"

      delete => tidy;

commands:

 new_patch::

   "/bin/echo Run patch file /tmp/$(last)",

    comment => "Patch a named software entity to a specific hash",
    action => notesuccess("File $() Patch attempt with status $(this.status)");

}


#########################################################

body delete tidy

{
dirlinks => "delete";          #keep/tidy/delete
rmdirs   => "true";             #none/all/sub
}

########################################

body classes define(a)
{
promise_repaired => { "$(a)" };
}

#########################################################

body copy_from rcp(from,server)

{
servers     => { "$(server)" };
source      => "$(from)";
compare     => "digest";
encrypt     => "false";
trustkey    => "true";
}

